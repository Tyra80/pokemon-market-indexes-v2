# ============================================================
# Pokemon Market Indexes v2 - Daily Index Calculation
# ============================================================
# Calculates index values daily using Laspeyres chain-linking
# Time: 14:00 Paris (13:00 UTC) - 1 hour after price fetch
#
# J-2 STRATEGY:
# - Uses prices from J-2 (fetched by daily_prices workflow)
# - Guaranteed complete volume data (24-48h consolidation)
# - Example: On Jan 7th, index is calculated with Jan 5th prices
#
# Features:
# - Daily index calculation (RARE_100, RARE_500, RARE_ALL)
# - Automatic monthly rebalancing on 1st of month
# - Smart liquidity (B+C+D method with volume decay)
# ============================================================

name: Daily Index Calculation

on:
  schedule:
    - cron: '0 13 * * *'
  workflow_dispatch:
    inputs:
      force_rebalance:
        description: 'Force monthly rebalancing'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  calculate-index:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: üìä Calculate Daily Index
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          FORCE_REBALANCE: ${{ github.event.inputs.force_rebalance || 'false' }}
        run: |
          if [ "$FORCE_REBALANCE" = "true" ]; then
            echo "üîÑ Force rebalancing enabled"
            python scripts/calculate_index.py --rebalance
          else
            python scripts/calculate_index.py
          fi
      
      - name: ‚úÖ Log success
        if: success()
        run: echo "‚úÖ Daily index calculation completed (Laspeyres chain-linking)"
      
      - name: ‚ùå Log failure
        if: failure()
        run: echo "‚ùå Daily index calculation failed"